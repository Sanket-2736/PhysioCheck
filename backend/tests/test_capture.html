<!DOCTYPE html>
<html>
<head>
  <title>Rep Capture Test</title>
  <style>
    body { font-family: Arial; }
    video { width: 480px; border: 1px solid #ccc; }
    button { padding: 10px 16px; margin-top: 10px; }
    pre { background: #111; color: #0f0; padding: 10px; }
  </style>
</head>
<body>

<h2>PhysioCheck â€“ Capture Rep Test</h2>

<video id="video" autoplay playsinline></video><br>
<button onclick="start()">Start Capture</button>
<button onclick="stop()">Stop & Send</button>

<pre id="log"></pre>

<script>
const EXERCISE_ID = 3;
const API_URL = `http://localhost:8000/exercises/${EXERCISE_ID}/capture-rep`;
const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo4LCJyb2xlIjoicGh5c2ljaWFuIiwiZXhwIjoxNzY1ODkxNDE0fQ.W3Gpsipw71b4zS_9H9f5-Yb0Bxf5psYe9qYBVYF5a8U";

let frames = [];
let stream = null;
let timer = null;

const log = (msg) =>
  document.getElementById("log").textContent += msg + "\n";

async function start() {
  frames = [];
  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  timer = setInterval(captureFrame, 100); // ~10 FPS
  log("ðŸ“¸ Capturing frames...");
}

function stop() {
  clearInterval(timer);
  stream.getTracks().forEach(t => t.stop());
  sendFrames();
}

function captureFrame() {
  // ðŸ”´ MOCK pose data (replace later with MediaPipe)
  frames.push({
    timestamp: Date.now() / 1000,
    joints: {
      left_shoulder: { x: 0.4, y: 0.3 },
      left_elbow: { x: 0.45, y: 0.45 }
    },
    angles: {
      left_shoulder: 40 + Math.random() * 60,
      left_elbow: 30 + Math.random() * 40
    }
  });
}

async function sendFrames() {
  log(`ðŸ“¤ Sending frames: ${frames.length}`);

  const res = await fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${TOKEN}`
    },
    body: JSON.stringify({ frames })
  });

  const data = await res.json();
  log("âœ… Response:");
  log(JSON.stringify(data, null, 2));
}
</script>

</body>
</html>
